function edb = erle(d, e, l)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ECHO RETURN LOSS ENHANCEMENT
%
% 30 June 2009
% Danilo Comminiello
%
% Department of Information, Electronic and Telecommunication Engineering 
% 'Sapienza' University of Rome
% Via Eudossiana,18, I-00184 Roma, Italy
%
%
% Echo Return Loss Enhancement (ERLE)
%
% DESCRIPTION:
% L'ERLE è calcolato dal rapporto Potenza segnale desiderato (d) su Potenza
% sengale di errore (e), esprimendo il risultato in dB. La potenza
% istantanea viene calcolata su una finestra di l campioni, un valore può
% essere calcolato in automatico nel caso in cui l sia omesso
%
% INPUT PARAMETERS:
%   d: desired signal (signal convolved with the room impulse response and
%      possible summed with background noise and/or near end signal)
%   e: error signal
%   l: window length
%
% OUTPUT PARAMETERS:
%   edb: echo return loss enhancement in dB
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if nargin < 3,
    l = 1000;
end

% Dimension chack
if length(d) > length(e),
    d((length(e))+1:length(d)) = [];
elseif length(e) > length(d),
    e((length(d)+1):length(e)) = [];
end


% Main

H = dfilt.dffir(ones(1,l));
pr = filter(H,d.^2) ./ (filter(H,e.^2)+0.00001)+0.00001;                   % Power ratio
edb = 10*log10(pr);

end